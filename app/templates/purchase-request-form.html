<!doctype html>
<html lang="zh-Hant-TW">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-PI8n5gCcz9cQqQXm3PEtDuPG8qx9oFsFctPg0S5zb8g=" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI=" crossorigin="anonymous">
    <style>
        :root {
            font-family: Jost, "Microsoft JhengHei", 微軟正黑體, 微软雅黑, sans-serif, 'Noto Sans TC', -apple-system, Arial, BlinkMacSystemFont, 'Helvetica Neue', Helvetica, 'Nimbus Sans L', Arial, 'Liberation Sans', 'PingFang SC', 'Hiragino Sans GB', 'Source Han Sans CN', 'Source Han Sans SC', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'WenQuanYi Zen Hei', 'ST Heiti', SimHei, 'WenQuanYi Zen Hei Sharp', sans-serif;
            --bracket-before: "";
            --bracket-after: "";
        }

        .container {
            max-width: 800px;
        }

        .selfdefined-scrollbar {
            overflow-x: hidden;
            overflow-y: auto;
            height: 120px;
        }

        .selfdefined-scrollbar::-webkit-scrollbar {
            width: 6px;
            /* Adjust width as needed */
        }

        .selfdefined-scrollbar::-webkit-scrollbar-thumb {
            background-color: #aaa;
            border-radius: 10px;
        }

        .selfdefined-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #888;
        }

        .selfdefined-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .material-info-container {
            display: grid;
            height: 100%;
            grid-template-columns: 2fr 3fr;
            gap: 0.35rem;
            font-size: 0.875rem;
            word-wrap: break-word;
            word-break: break-all;
        }

        .material-info-container p {
            margin: 0;
        }

        .material-info-container-title {
            grid-column: 1 / -1;
            margin: 0;
            color: #2c3e50;
            font-family: 微軟正黑體;
        }

        .transparent-label {
            color: transparent;
        }

        .transparent-border {
            border-color: transparent;
        }

        .bracket::before {
            content: var(--bracket-before);
        }

        .bracket::after {
            content: var(--bracket-after);
        }

        .editedFileName {
            border: none;
        }

        .fileBox {
            width: 100px;
            height: 100px;
        }

        .file-info-grid {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 0.5rem;
        }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
        }
    </style>

    <title>工程部-物料請購表單</title>
</head>

<body class="bg-light">
    <div class="container">
        <header class="m-2"></header>
        <main class="px-1 pt-1 pb-4 bg-white rounded-top-3 shadow">
            <div class="d-flex justify-content-between">
                <button type="button" class="btn p-0" style="width: 50px; height: 50px;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-50 h-50 bi bi-reply-fill text-secondary" viewBox="0 0 16 16" style="opacity: .45;">
                        <path d="M5.921 11.9 1.353 8.62a.72.72 0 0 1 0-1.238L5.921 4.1A.716.716 0 0 1 7 4.719V6c1.5 0 6 0 7 8-2.5-4.5-7-4-7-4v1.281c0 .56-.606.898-1.079.62z" />
                    </svg>
                </button>
            </div>
            <form id="purchase-request-form" autocomplete="off">
                <fieldset class="mx-5 my-2">
                    <div class="text-center mb-4">
                        <img src="{{ url_for('static', filename='images/banner.png') }}" alt="Banner" class="img-fluid rounded">
                    </div>
                    <h3 class="p-2 text-start fw-bolder rounded-2" style="letter-spacing: 0.4rem;">
                        工程部請購單 (內部)
                    </h3>
                    <hr class="my-4">
                    <div class="row mb-3 align-items-stretch">
                        <div class="col-6">
                            <div class="m-2 p-1">
                                <div class="d-flex align-items-center">
                                    <label for="Input_supplier" class="form-label">供應商</label>
                                    <button type="button" class="btn form-label p-0 ms-2 border-0 text-danger clr-input-btn d-none align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eraser-fill m-0 p-0 pe-none" viewBox="0 0 16 16">
                                            <path class="pe-none" d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"/>
                                        </svg>
                                    </button>
                                </div>
                                <input type="text" class="form-control" id="Input_supplier" list="supplier_datalist">
                                <datalist id="supplier_datalist"></datalist>
                            </div>
                            <div class="m-2 p-1">
                                <div class="d-flex align-items-center">
                                    <label for="Input_materialId" class="form-label">料號</label>
                                    <button type="button" class="btn form-label p-0 ms-2 border-0 text-danger clr-input-btn d-none align-items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eraser-fill m-0 p-0 pe-none" viewBox="0 0 16 16">
                                            <path class="pe-none" d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"/>
                                        </svg>
                                    </button>
                                </div>
                                <input type="text" class="form-control" id="Input_materialId" maxlength="38" list="material_datalist">
                                <datalist id="material_datalist"></datalist>
                            </div>
                            <div class="m-2 p-1">
                                <label for="Input_materialType" class="form-label">物料類別</label>
                                <select id="Input_materialType" class="form-select" aria-label="Default select example" disabled>
                                    <option selected>Open this select menu</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6 d-flex flex-column">
                            <div class="mx-3 mt-2 px-4 pt-2 pb-2 bg-secondary border rounded-3 flex-fill selfdefined-scrollbar" style="--bs-bg-opacity: .025;">
                                <div class="material-info-container">
                                    <div class="material-info-container-title d-flex align-items-center mb-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            fill="currentColor" class="bi bi-signpost-split me-1" viewBox="0 0 16 16"
                                            style="opacity: .65;">
                                            <path d="M7 7V1.414a1 1 0 0 1 2 0V2h5a1 1 0 0 1 .8.4l.975 1.3a.5.5 0 0 1 0 .6L14.8 5.6a1 1 0 0 1-.8.4H9v10H7v-5H2a1 1 0 0 1-.8-.4L.225 9.3a.5.5 0 0 1 0-.6L1.2 7.4A1 1 0 0 1 2 7zm1 3V8H2l-.75 1L2 10zm0-5h6l.75-1L14 3H8z" />
                                        </svg>
                                        <h6 class="fw-bold mb-0" style="letter-spacing: 0.15rem;">物料資訊</h6>
                                        <span class="mx-1"></span>
                                        <button id="add-material-btn" type="button" class="btn p-0 mx-2 mt-1 border-0 material-info-container-title d-flex align-items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-plus pe-none" viewBox="0 0 16 16">
                                                <path class="pe-none" fill-rule="evenodd" d="M8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7"/>
                                                <path class="pe-none" d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                                                <path class="pe-none" d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                                            </svg>
                                        </button>
                                        <button id="update-material-btn" type="button" class="btn p-0 mx-2 mt-1 border-0 material-info-container-title d-none align-items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square pe-none" viewBox="0 0 16 16">
                                                <path class="pe-none" d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                                <path class="pe-none" fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                                            </svg>
                                        </button>
                                        <button id="show-purchase-history-btn" type="button" class="btn p-0 mx-2 mt-1 border-0 material-info-container-title d-none align-items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-journal-bookmark pe-none" viewBox="0 0 16 16">
                                                <path class="pe-none" fill-rule="evenodd" d="M6 8V1h1v6.117L8.743 6.07a.5.5 0 0 1 .514 0L11 7.117V1h1v7a.5.5 0 0 1-.757.429L9 7.083 6.757 8.43A.5.5 0 0 1 6 8"/>
                                                <path class="pe-none" d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2"/>
                                                <path class="pe-none" d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1z"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="fw-bold" style="letter-spacing: 0.15rem;">
                                        <p>品名：</p>
                                    </div>
                                    <div>
                                        <p id="parts-name" class="bracket"></p>
                                    </div>
                                    <div class="fw-bold" style="letter-spacing: 0.15rem;">
                                        <p>單價：</p>
                                    </div>
                                    <div>
                                        <p id="unit-price"></p>
                                    </div>
                                    <div class="fw-bold" style="letter-spacing: 0.15rem;">
                                        <p>報價單：</p>
                                    </div>
                                    <div>
                                        <!-- <a id="quotation-link" hidden></a> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-3">
                            <div class="mx-2 my-2 p-1">
                                <label for="Input_quantity" class="form-label">數量</label>
                                <input type="number" class="form-control text-center" id="Input_quantity" min="0" step="any">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="m-1 p-2">
                                <p class="form-label text-center transparent-label">x</p>
                                <p class="form-control m-0 transparent-border text-center">x</p>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="m-1 p-2">
                                <p class="form-label text-center w-100">單價</p>
                                <p id="unit-price-2" class="form-control m-0 transparent-border text-center">0</p>
                                <input type="number" class="form-control text-center" id="Input_unitPrice" min="0" step="any" value="0" hidden>
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="m-1 p-2">
                                <p class="form-label text-center transparent-label">=</p>
                                <p class="form-control m-0 transparent-border text-center">=</p>
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="m-1 p-2">
                                <p class="form-label text-center w-100">總價預覽</p>
                                <p id="total-price" class="form-control m-0 transparent-border text-center"></p>
                            </div>
                        </div>
                    </div>
                    <div class="m-2 p-1">
                        <div class="d-flex align-items-center">
                            <label for="Input_applier" class="form-label">申請人</label>
                            <button type="button" class="btn form-label p-0 ms-2 border-0 text-danger clr-input-btn d-none align-items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eraser-fill m-0 p-0 pe-none" viewBox="0 0 16 16">
                                    <path class="pe-none" d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"/>
                                </svg>
                            </button>
                        </div>
                        <input type="text" class="form-control" id="Input_applier" placeholder="工號簡碼 = 001" list="employee_datalist">
                        <datalist id="employee_datalist"></datalist>
                    </div>
                    <div class="m-2 p-1">
                        <label for="Input_requiredDate" class="form-label">需求日期</label>
                        <input type="date" class="form-control" id="Input_requiredDate">
                    </div>
                    <div class="m-2 p-1">
                        <label for="Input_delieveryOffice" class="form-label">收貨廠區</label>
                        <select id="Input_delieveryOffice" class="form-select" aria-label="Default select example">
                            <option selected>Open this select menu</option>
                        </select>
                    </div>
                    <div class="m-2 p-1">
                        <label for="Input_purchaseReason" class="form-label">請購原因</label>
                        <select id="Input_purchaseReason" class="form-select" aria-label="Default select example">
                            <option selected>Open this select menu</option>
                        </select>
                    </div>
                    <div class="m-2 p-1">
                        <label for="Input_projectName" class="form-label">隸屬於專案</label>
                        <select id="Input_projectName" class="form-select" aria-label="Default select example">
                            <option selected>Open this select menu</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="m-2 p-1">
                                <label for="Input_description" class="form-label">用途說明</label>
                                <textarea id="Input_description" class="form-control" rows="4" maxlength="50" placeholder="*Note簽核看的*"></textarea>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="m-2 p-1">
                                <label for="Input_remarks" class="form-label">請購備註</label>
                                <textarea id="Input_remarks" class="form-control" rows="4" maxlength="50" placeholder="*資材部看的*"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="m-2 p-1">
                        <label for="Input_files" class="form-label" style="cursor: pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle pe-none" viewBox="0 0 16 16">
                                <path class="pe-none" d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                <path class="pe-none" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                            </svg>
                            附檔
                        </label>
                        <input type="file" id="Input_files" multiple style="display: none;">
                        <div id="fileList" class="w-100"></div>
                    </div>
                </fieldset>
                <div class="d-flex justify-content-center">
                    <button type="submit" class="btn btn-lg btn-primary rounded-3">提交</button>
                </div>
            </form>
        </main>
        <footer class="my-5 text-muted text-center text-small"></footer>
    </div>
    <!-- Modal 結構: 彈窗預覽檔案 -->
    <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-labelledby="filePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filePreviewModalLabel">文件預覽</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <iframe id="filePreviewIframe" width="100%" height="600px" class="d-none"></iframe>
                    <video id="videoPlayer" controls class="w-100 d-none">
                        Your browser does not support the video tag.
                    </video>
                    <audio id="audioPlayer" controls class="w-100 d-none">
                        Your browser does not support the audio element.
                    </audio>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.2/lib/bundle.js" integrity="sha256-b4/iTif0LxfGrbF3LLsHwg852tbYcHbLpHMJnY3PsTo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha256-CDOy6cOibCWEdsRiZuaHf8dSGGJRYuBGC+mjoJimHGw=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        (() => {
            const resourceName_get = [
                'suppliers',            // 供應商表
                'units',                // 單位表
                'currencies',           // 幣別表
                'employees',            // 員工表
                'projects',             // 專案表
                'minmaxOffice',         // 捷拓廠區表
                'purchaseType',         // 請購原由表
                'materialType',         // 物料種類表
                'materials',            // 物料表
            ];

            const dataFrame = {};

            let materialBuffer_ptr = 0;

            const materialBuffer = {};
            materialBuffer[materialBuffer_ptr] = {
                供應商簡稱: '',
                物料代號: '',
                物料類別: '',
                單價: 0,
                幣別: 'TWD',
                需求數量: 0,
                ext: {
                    isInDataFrame: false,
                    isUnitPriceInputBinding: true,
                    unitPrice_substituted: 0,
                    unitPrice_input: 0,
                }
            };

            let fileBuffer_ptr = 0;
            let fileBuffer = {};
            
            // 定義請購明細模板創建函數
            function createPurchaseRequestStmtBuffer() {
                return {
                    供應商簡稱: '',
                    物料代號: '',
                    單價: 0,
                    幣別: 'TWD',
                    物料類別: '',
                    需求數量: 0,
                    申請人工號簡碼: '',
                    需求到貨日期: '',
                    收貨廠區: '',
                    請購類型: '',
                    專案名稱: '',
                    用途說明: '',
                    備註: '',
                };
            }

            // 定義檔案資訊模板創建函數
            function createFileBuffer() {
                return {
                    默認主鍵: '',
                    內容分類: '其他文件',
                    檔案說明: '',
                    副檔名: '',
                    檔案路徑: '',
                    哈希值: '',
                    ext: {
                        檔案: null,
                        檔案種類: '',
                        圖示bs: '',
                        圖示顏色: '',
                        預覽檔案: null,
                        預覽檔案狀態: 'init',
                    }
                };
            }

            // 用以讀取主要相依資源
            function fetchResource(resourceName) {
                const url = new URL(`/api/${resourceName}`, window.location.origin);
                return fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        dataFrame[resourceName] = new dfd.DataFrame(data);
                        // console.log(`Fetched ${resourceName}`);
                    })
                    .catch(error => console.error(`Error fetching ${resourceName}:`, error));
            }
            
            // function postResource(resourceName, data) {
            //     return fetch(`/api/${resourceName}`, {
            //         method: 'POST',
            //         headers: {
            //             'Content-Type': 'application/json'
            //         },
            //         body: JSON.stringify(data)
            //     })
            //     .then(response => response.json())
            //     .then(data => {
            //         if (data.error) {
            //             console.error('Error:', data.error);
            //             alert('請求提交失敗：' + data.error);
            //         }
            //         else {
            //             console.log('Success:', data);
            //             alert('請求提交成功！' + data.message);
            //         }
            //     })
            //     .catch(error => {
            //         console.error('Error:', error);
            //         alert('資料提交時發生錯誤：' + error.message);
            //     });
            // }

            // 檢查檔案是否存在檔案管理系統
            async function checkFileExistence({ primeKey = null, hash = null } = {}) {
                try {
                    // 創建URL對象，基於當前頁面的根URL
                    const url = new URL('/api/files/checkFileExistence', window.location.origin);

                    // 根據條件添加查詢參數
                    if (primeKey) {
                        url.searchParams.append('primeKey', primeKey);
                    }
                    else if (hash) {
                        url.searchParams.append('hash_SHA256', hash);
                    }
                    else {
                        throw new Error('不明的查詢條件');
                    }

                    // 發送GET請求
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    return data;
                } catch (error) {
                    console.error('Error: 檢查檔案是否存在伺服器失敗\n' + error);
                    alert('檢查檔案是否存在伺服器失敗:' + error);
                    return null;
                }
            }

            // 從後端取得檔案
            async function fetchAttachment(primeKey) {
                try {
                    // 創建URL對象，基於當前頁面的根URL
                    const url = new URL(`/api/files/${primeKey}`, window.location.origin);
                    const response = await fetch(url);
                    const contentType = response.headers.get('Content-Type');

                    // 根據本api的設定，json格式是報錯時才會回傳，檔案回傳由後端自動判斷mimetype。
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data.error) throw new Error(data.error);
                        else throw new Error('Unknown error in JSON response');
                    }
                    else if (contentType) {
                        let blob = await response.blob();
                        let contentDisposition = response.headers.get('Content-Disposition');
                        let filename = '原檔名遺失';
                        if (contentDisposition) {
                            // 優先處理 filename* (RFC 5987 格式編碼，可以解析中文)
                            let match = contentDisposition.match(/filename\*=(?:UTF-8'')?([^;\n]*)/);
                            if (match && match[1]) {
                                filename = decodeURIComponent(match[1].replace(/['"]/g, ''));
                            }
                            else {
                                // 處理 filename (無法解析中文)
                                match = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                                if (match && match[1]) {
                                    filename = match[1].replace(/['"]/g, '');
                                }
                            }
                        }
                        return new File([blob], filename, { type: contentType });
                    }
                    else
                        throw new Error('Unknown response type');
                } catch (error) {
                    console.error('Error: 傳輸伺服器附件時發生錯誤\n' + error);
                    alert('傳輸伺服器附件時發生錯誤：' + error.message);
                    return null;
                }
            }

            // 上傳物料報價單
            async function uploadAttachment(formData) {
                try {
                    const url = new URL('/api/files', window.location.origin);
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        return {'status': '上傳成功', 'message': data.message, 'id': data.id, 'path': data.path};
                    }
                    else {
                        throw new Error(data.error);
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Error: 上傳附件失敗\n' + error.message);
                    return {'status': '上傳失敗', 'message': error.message, 'id': null, 'path': null};
                }
            }

            // 建立伺服器暫存
            async function cacheAttachment(formData) {
                formData.append('快取', true);
                return await uploadAttachment(formData);
            }

            // 更新附件元數據
            async function updateAttachmentMeta(formData, primeKey) {
                try {
                    const url = new URL(`/api/files/${primeKey}`, window.location.origin);
                    const response = await fetch(url, {
                        method: 'PATCH',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        let message = [];
                        Object.entries(data.updatedFields).forEach(([key, value]) => key!='快取' && message.push(`${key}: ${value[0] || 'NULL'} -> ${value[1] || 'NULL'}`));
                        return {'status': '更新成功', 'message': `附件元數據更新成功！\n已更新的欄位信息:\n${message.join('\n')}`};
                    }
                    else {
                        throw new Error(data.error);
                    }
                    return data;
                } catch (error) {
                    console.error('Error: 更新附件元數據失敗\n' + error.message);
                    return {'status': '更新失敗', 'message': '附件元數據更新失敗！\n' + error.message};
                }
            }

            // 從後端取得預覽用的pdf檔案(相依於Office，限定相關檔案類型)
            async function fetchPreviewFile(primeKey) {
                try {
                    const url = new URL(`/api/files/${primeKey}/retrievePreviewPDF`, window.location.origin);
                    const response = await fetch(url);
                    
                    const contentType = response.headers.get('Content-Type');
                    if (contentType && contentType.includes('application/pdf')) {
                        let previewFile = await response.blob();
                        return {'status': '轉檔成功', 'file': previewFile};
                    }
                    else if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data.error) throw new Error(data.message || data.error);
                        else throw new Error('Unknown error in JSON response');
                    }
                    else
                        throw new Error('Unknown response type');
                } catch (error) {
                    console.error('轉檔為 PDF 時發生錯誤\n' + error);
                    alert('轉檔為 PDF 時發生錯誤：\n' + error.message);
                    return {'status': '轉檔失敗', 'file': null, 'message': error.message};
                }
            }

            // 轉檔為可以預覽的pdf檔
            async function convertToPreviewFile(formData) {
                try {
                    const url = new URL('/api/fileToPdf', window.location.origin);
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const contentType = response.headers.get('Content-Type');
                    if (contentType && contentType.includes('application/pdf')) {
                        let previewFile = await response.blob();
                        return {'status': '轉檔成功', 'file': previewFile};
                    }
                    else if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data.error) throw new Error(data.error);
                        else throw new Error('Unknown error in JSON response');
                    }
                    else
                        throw new Error('Unknown response type');
                } catch (error) {
                    console.error('轉檔為 PDF 時發生錯誤\n' + error);
                    alert('轉檔為 PDF 時發生錯誤：\n' + error.message);
                    return {'status': '轉檔失敗', 'file': null, 'message': error.message};
                }
            }

            // 上傳請購明細
            async function uploadPurchaseReqStmt(PurchaseReqStmtFormValues) {
                try {
                    const url = new URL('/api/purchaseRequestStmts', window.location.origin);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(PurchaseReqStmtFormValues)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        return {'status': '上傳成功', 'message': data.message, 'id': data.id, 'reqStmtStatus': data.reqStmtStatus};
                    }
                    else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error:', error.message);
                    return {'status': '上傳失敗', 'message': error.message}
                }
            }

            async function bindStmtWithAttachment({purchaseRequestStmtPrimeKey, filePrimeKey}={}) {
                console.log({
                    purchaseRequestStmtPrimeKey: purchaseRequestStmtPrimeKey,
                    filePrimeKey: filePrimeKey,
                });
                try {
                    const url = new URL('/api/bind/purchaseRequestStmt-attachment', window.location.origin);
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            purchaseRequestStmtPrimeKey: purchaseRequestStmtPrimeKey,
                            filePrimeKey: filePrimeKey,
                        })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        return {'status': '綁定成功', 'message': data.message};
                    }
                    else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error: 請購明細與附件綁定失敗\n' + error.message);
                    return {'status': '綁定失敗', 'message': error.message};
                }
            }

            // 重新導向至物料表單
            function redirectToMaterialForm(type) {
                if (type === '創建' || type === '更新'){
                    let data = {
                        '供應商簡稱': material.供應商簡稱,
                        '物料代號': material.物料代號,
                        '申請人工號簡碼': applier,
                        '收貨廠區': delieveryOffice,
                        '物料表單類型': type,
                        '遞交資材部': true,
                    };
                }
            }

            // 檢查已輸入表單的物料內容是否符合提交表單的規範
            // function checkMaterialBuffer(buffer) {
            //     if (buffer.物料代號 === 'FREIGHT') {
            //         let query = dataFrame.suppliers.loc({ rows: dataFrame.suppliers['簡稱'].eq(buffer.供應商簡稱)});
            //         if (query.shape[0] !== 1) return [false, '供應商在資料庫不存在或重複'];
            //     }
            //     else if (buffer.供應商簡稱 && buffer.物料代號) {
            //         let query = dataFrame.materials.loc({ rows: dataFrame.materials['物料代號'].eq(buffer.物料代號).and(dataFrame.materials['供應商簡稱'].eq(buffer.供應商簡稱)) });
            //         if (query.shape[0] !== 1) return [false, '物料不存在'];
            //     }
            //     return [true, ''];
            // }

            // 截取當前表單內容
            function getFormValues(material) {
                const purchaseReqStmtFormValues = createPurchaseRequestStmtBuffer();

                purchaseReqStmtFormValues.供應商簡稱 = material.供應商簡稱;
                purchaseReqStmtFormValues.物料代號 = material.物料代號;
                purchaseReqStmtFormValues.單價 = material.單價;
                purchaseReqStmtFormValues.幣別 = material.幣別;
                purchaseReqStmtFormValues.物料類別 = material.物料類別;
                purchaseReqStmtFormValues.需求數量 = material.需求數量;
                purchaseReqStmtFormValues.申請人工號簡碼 = document.getElementById('Input_applier').value;
                purchaseReqStmtFormValues.需求到貨日期 = document.getElementById('Input_requiredDate').value;
                purchaseReqStmtFormValues.收貨廠區 = document.getElementById('Input_delieveryOffice').value;
                purchaseReqStmtFormValues.請購類型 = document.getElementById('Input_purchaseReason').value;
                purchaseReqStmtFormValues.專案名稱 = document.getElementById('Input_projectName').value;
                purchaseReqStmtFormValues.用途說明 = document.getElementById('Input_description').value;
                purchaseReqStmtFormValues.備註 = document.getElementById('Input_remarks').value;
                
                return purchaseReqStmtFormValues;
            }

            // 檢查表單內容是否符合規範，回傳警告
            function checkFormValues(purchaseReqStmtFormValues) {
                let warnings = [];

                !(purchaseReqStmtFormValues.供應商簡稱) && warnings.push('- 沒寫供應商');
                !(purchaseReqStmtFormValues.物料代號) && warnings.push('- 沒寫料號');
                !(purchaseReqStmtFormValues.物料類別) && warnings.push('- 沒寫物料類別');
                !(purchaseReqStmtFormValues.需求數量) && warnings.push('- 沒寫需求數量');
                !(purchaseReqStmtFormValues.單價) && warnings.push('- 沒寫單價');
                !(purchaseReqStmtFormValues.幣別) && warnings.push('- 沒寫幣別');
                !(purchaseReqStmtFormValues.申請人工號簡碼) && warnings.push('- 沒寫請購者');
                !(purchaseReqStmtFormValues.需求到貨日期) && warnings.push('- 沒寫需求日');
                !(purchaseReqStmtFormValues.收貨廠區) && warnings.push('- 沒寫收貨廠區');
                !(purchaseReqStmtFormValues.用途說明) && warnings.push('- 沒寫用途說明');

                if (warnings.length === 0) {
                    return {
                        'status': '成功',
                        'message': '',
                    };
                }
                else {
                    return {
                        'status': '失敗',
                        'message': warnings.join('\n'),
                    };
                }
            }

            // 送出表單
            async function submitPurchaseReqStmtForm(event) {
                event && event.preventDefault();

                // 錯誤信息暫存
                let failedAttachmentChecks = [];
                let failedFormValueChecks = [];

                let StmtFormValueBuffers = [];

                const check_promises = [
                    // 附件檔案預傳輸&檢查
                    Object.entries(fileBuffer).map(async ([key, buffer]) => {
                        try {
                            const formData = new FormData();
                            if (buffer.默認主鍵) {
                                const checkFileExistenceReturn = await checkFileExistence({ primeKey: buffer.默認主鍵 });
                                if (checkFileExistenceReturn && checkFileExistenceReturn.found) {
                                    let changeFlag = false;
                            
                                    if (checkFileExistenceReturn.檔案說明 && checkFileExistenceReturn.檔案說明 !== buffer.檔案說明) {
                                        formData.append('檔案說明', buffer.檔案說明);
                                        changeFlag = true;
                                    }
                                    if (checkFileExistenceReturn.內容分類 && checkFileExistenceReturn.內容分類 !== buffer.內容分類) {
                                        formData.append('內容分類', buffer.內容分類);
                                        changeFlag = true;
                                    }
                                    if (checkFileExistenceReturn.副檔名 && checkFileExistenceReturn.副檔名 !== buffer.副檔名) {
                                        formData.append('副檔名', buffer.副檔名);
                                        changeFlag = true;
                                    }

                                    if (changeFlag) {
                                        const updateAttachmentMetaReturn =  await updateAttachmentMeta(formData, buffer.默認主鍵);
                                        if (updateAttachmentMetaReturn.status === '更新失敗') throw new Error(updateAttachmentMetaReturn.message);
                                    }
                                }
                                else if (buffer.ext.檔案) {
                                    formData.append('file', buffer.ext.檔案);
                                    formData.append('內容分類', buffer.內容分類);
                                    formData.append('檔案說明', buffer.檔案說明);
                                    formData.append('副檔名', buffer.副檔名);
                                    formData.append('哈希值', buffer.哈希值);
                                    const uploadAttachmentReturn = await uploadAttachment(formData);
                                    if (uploadAttachmentReturn.status === '上傳失敗') throw new Error(uploadAttachmentReturn.message);
                                    buffer.默認主鍵 = uploadAttachmentReturn.id;
                                }
                            }
                            else if (buffer.ext.檔案) {
                                formData.append('file', buffer.ext.檔案);
                                formData.append('內容分類', buffer.內容分類);
                                formData.append('檔案說明', buffer.檔案說明);
                                formData.append('副檔名', buffer.副檔名);
                                formData.append('哈希值', buffer.哈希值);
                                const uploadAttachmentReturn = await uploadAttachment(formData);
                                if (uploadAttachmentReturn.status === '上傳失敗') throw new Error(uploadAttachmentReturn.message);
                                buffer.默認主鍵 = uploadAttachmentReturn.id;
                            }
                        } catch (error) {
                            failedAttachmentChecks.push({
                                'fileBufferKey': key,
                                'message': error.message,
                            });
                        }
                    }),
                    // 請購表單檢查
                    Object.entries(materialBuffer).map(async ([key, buffer]) => {
                        try {
                            // 檢查暫存器代入內容是否出錯
                            // [result, message] = checkMaterialBuffer(buffer);

                            // 取得欲送出的單一明細內容
                            let purchaseReqStmtFormValues = getFormValues(buffer);

                            // 檢查表單內容
                            const checkFormValuesReturn = checkFormValues(purchaseReqStmtFormValues);
                            if (checkFormValuesReturn.status === '失敗') throw new Error(checkFormValuesReturn.message);
                            else StmtFormValueBuffers.push(purchaseReqStmtFormValues);
                        } catch (error) {
                            failedFormValueChecks.push({
                                'materialBufferKey': key,
                                'message': error.message,
                            });
                            console.log({
                                'materialBufferKey': key,
                                'message': error.message,
                            });
                        }
                    })
                ];
                await Promise.all(check_promises);

                if (failedAttachmentChecks.length === 0 && failedFormValueChecks.length === 0) {
                    const submit_promises = StmtFormValueBuffers.map(async stmt => {
                        try {
                            let uploadReturn = await uploadPurchaseReqStmt(stmt);
                            let stmtId = uploadReturn.id;
                            if (stmtId) {
                                Object.values(fileBuffer).map(async buffer => {
                                    await bindStmtWithAttachment({'purchaseRequestStmtPrimeKey': stmtId, 'filePrimeKey': buffer.默認主鍵});
                                });
                            }
                        } catch (error) {

                        }
                    });
                    await Promise.all(submit_promises);

                    '**此處應該添加更多數據傳出未完成的防禦性編程**'
                    '**如果需要進行數據傳輸狀態追蹤，請於完成傳輸狀態註冊表dataExchangingRegister()相關實作。**'
                    
                    alert('表單已提交！');

                    this.reset();
                    window.location.reload();                
                }
                else {
                    let tmp = `
                        [附件檢查]\n
                        ${failedAttachmentChecks}
                        \n
                        [表單檢查]\n
                        ${failedFormValueChecks}
                    `;
                    alert(tmp);
                    return false;
                }
            }

            // 為指定的 <select> OR <datalist> 設置選項，首先清除所有現有選項，然後添加一個預設選項和選項清單
            function setupSelectOptions (selector, list, hasEmptyOption = false) {
                // 清除 selector 中的所有子節點
                while (selector.firstChild) selector.removeChild(selector.firstChild);

                // 創建並添加一個預設選項，該選項被禁用且被隱藏
                const defaultOption = new Option('請選擇一個選項', '', true, true);
                defaultOption.hidden = !hasEmptyOption;
                selector.appendChild(defaultOption);

                // 創建一個文檔片段
                let fragment = document.createDocumentFragment();

                // 遍歷清單元素，創建並添加選項
                Array.from(new Set(list)).forEach(columnName => fragment.appendChild(new Option(columnName, columnName)));

                // 將文檔片段中的所有選項一次性添加到 selector 中
                selector.appendChild(fragment);
            }

            // 清除該區塊內<input>值
            function clearTextbox(clickEvent) {
                let input_el = clickEvent.target.parentElement.parentElement.querySelector('input');
                input_el.value = '';
                input_el.dispatchEvent(new Event('input', { bubbles: true }));
                input_el.focus();
            }

            // 刪除指定鍵值已渲染的檔案UI物件與檔案緩存器
            function deleteFileBuffer(key) {
                document.getElementById(`fileCtrlBlock-${key}`).remove();
                delete fileBuffer[key];
            }

            // 清空已渲染的檔案UI物件與檔案緩存器
            function clearFileBuffer() {
                const keys = Object.keys(fileBuffer);
                keys.forEach(key => deleteFileBuffer(key));
            }

            // 針對d-flex物件的顯示/隱藏設定
            function setDFlexElmVisibility(dflexElement, isVisible) {
                if (isVisible) {
                    dflexElement.classList.add('d-flex');
                    dflexElement.classList.remove('d-none');
                }
                else {
                    dflexElement.classList.add('d-none');
                    dflexElement.classList.remove('d-flex');
                }
            }

            // 設定清除快捷鍵是否顯示
            function setEraseIconVisibility(inputEvent) {
                let btn_el = inputEvent.target.parentElement.querySelector('button');
                setDFlexElmVisibility(btn_el, inputEvent.target.value);
            }

            // 單價區塊取值切換器
            // 若值不變，則不進行處理以節約效能。
            function setUnitPriceInputBinding(binding) {
                if (materialBuffer[materialBuffer_ptr].ext.isUnitPriceInputBinding === binding) return;

                materialBuffer[materialBuffer_ptr].ext.isUnitPriceInputBinding = binding;
                
                if (materialBuffer[materialBuffer_ptr].ext.isUnitPriceInputBinding) {
                    document.getElementById('unit-price-2').hidden = false;
                    document.getElementById('Input_unitPrice').hidden = true;
                }
                else {
                    document.getElementById('unit-price-2').hidden = true;
                    document.getElementById('Input_unitPrice').hidden = false;
                }
            }

            // 物料區塊輸入值變化狀態處理器
            function handleMtrlSecStatus() {
                const addMaterialBtn = document.getElementById('add-material-btn');
                const updateMaterialBtn = document.getElementById('update-material-btn');
                const showPurchaseHistoryBtn = document.getElementById('show-purchase-history-btn');
                const materialIdInput = document.getElementById('Input_materialId').value;
                const supplierNameInput = document.getElementById('Input_supplier').value;
                const materialType = document.getElementById('Input_materialType').value;
                let supplier_list = [];
                let material_list = [];
                let isMaterialChange = false;
                let isFreight = materialIdInput === 'FREIGHT'; // 判斷輸入值等於"FREIGHT"(運費)的flag

                // 以"供應商簡稱"建議使用者可填入的"物料代號"
                // 若值不變，則不進行處理以節約效能。 [例外] 強制添加運費選項。
                if (materialBuffer[materialBuffer_ptr].供應商簡稱 !== supplierNameInput) {
                    isMaterialChange = true;
                    materialBuffer[materialBuffer_ptr].供應商簡稱 = supplierNameInput;
                    // 有值就篩選，沒值就全部顯示。 
                    if (supplierNameInput)
                        material_list = dataFrame.materials.loc({ rows: dataFrame.materials['供應商簡稱'].eq(supplierNameInput) })['物料代號'].values.slice();
                    else
                        material_list = dataFrame.materials['物料代號'].values.slice();
                    material_list.unshift('FREIGHT'); // 放list首位
                    setupSelectOptions(document.getElementById('material_datalist'), material_list); // 物料表>料號
                }

                // 以"物料代號"建議使用者可填入的"供應商簡稱"
                // 若值不變，則不進行處理以節約效能。 [例外] 當materialIdInput=="FREIGHT"(運費)時調用全部供應商清單。
                if (materialBuffer[materialBuffer_ptr].物料代號 !== materialIdInput) {
                    isMaterialChange = true;
                    materialBuffer[materialBuffer_ptr].物料代號 = materialIdInput;
                    // 有值就篩選，沒值就全部顯示。 
                    if (isFreight)
                        supplier_list = dataFrame.suppliers['簡稱'].values;
                    else if (materialIdInput)
                        supplier_list = dataFrame.materials.loc({ rows: dataFrame.materials['物料代號'].eq(materialIdInput) })['供應商簡稱'].values;
                    else
                        supplier_list = dataFrame.materials['供應商簡稱'].values;
                    setupSelectOptions(document.getElementById('supplier_datalist'), supplier_list); // 物料表>供應商
                }

                if (materialBuffer[materialBuffer_ptr].物料類別 !== materialType) {
                    materialBuffer[materialBuffer_ptr].物料類別 = materialType;
                }

                // 以"供應商簡稱"與"物料代號"搜尋唯一符合的物料
                // 若值不變，則不進行處理以節約效能。 [例外] 當materialIdInput=="FREIGHT"(運費)時render指定內容。
                if (supplierNameInput && materialIdInput && isMaterialChange) {
                    let query = dataFrame.materials.loc({ rows: dataFrame.materials['物料代號'].eq(materialBuffer[materialBuffer_ptr].物料代號).and(dataFrame.materials['供應商簡稱'].eq(materialBuffer[materialBuffer_ptr].供應商簡稱)) });
                    const material = query.shape[0] === 1 ? dfd.toJSON(query)[0] : null;

                    // 有找到物料，則修改顯示。沒有找到物料，則清空顯示。
                    if (isFreight) {
                        let partName = '運費FREIGHT';
                        let unitPrice = 0;
                        let price = `-- NTD / SET`;

                        setDFlexElmVisibility(addMaterialBtn, false);
                        setDFlexElmVisibility(updateMaterialBtn, false);
                        setDFlexElmVisibility(showPurchaseHistoryBtn, true);
                        document.getElementById('parts-name').textContent = partName;
                        document.getElementById('unit-price').textContent = price;
                        // document.getElementById('quotation-link').hidden = true;
                        document.getElementById('Input_materialType').value = '製程雜費';
                        document.getElementById('Input_materialType').disabled  = true;
                        document.documentElement.style.setProperty('--bracket-before', '"["');
                        document.documentElement.style.setProperty('--bracket-after', '"]"');
                        // materialBuffer[materialBuffer_ptr].供應商簡稱 = supplierNameInput; // 已在上方if內添加
                        // materialBuffer[materialBuffer_ptr].物料代號 = materialIdInput; // 已在上方if內添加
                        materialBuffer[materialBuffer_ptr].物料類別 = '製程雜費';
                        materialBuffer[materialBuffer_ptr].幣別 = 'TWD';
                        materialBuffer[materialBuffer_ptr].ext.unitPrice_substituted = unitPrice;
                        materialBuffer[materialBuffer_ptr].ext.isInDataFrame = true;
                        setUnitPriceInputBinding(false);
                        handleUnitPriceChange();
                    }
                    else if (material) {
                        let partName = material['品名規格'];
                        let unitPrice = material['單價'];
                        let price = `${material['單價']} ${material['幣別']} / ${material['單位']}`;

                        setDFlexElmVisibility(addMaterialBtn, false);
                        setDFlexElmVisibility(updateMaterialBtn, true);
                        setDFlexElmVisibility(showPurchaseHistoryBtn, true);
                        document.getElementById('parts-name').textContent = partName;
                        document.getElementById('unit-price').textContent = price;
                        document.getElementById('Input_materialType').value = material['預設物料類別'] ? material['預設物料類別'] : '';
                        document.getElementById('Input_materialType').disabled  = false;
                        // let link = document.getElementById('quotation-link');
                        // link.textContent = 'Preview';
                        document.documentElement.style.setProperty('--bracket-before', '"["');
                        document.documentElement.style.setProperty('--bracket-after', '"]"');
                        // materialBuffer[materialBuffer_ptr].供應商簡稱 = supplierNameInput; // 已在上方if內添加
                        // materialBuffer[materialBuffer_ptr].物料代號 = materialIdInput; // 已在上方if內添加
                        materialBuffer[materialBuffer_ptr].物料類別 = material['預設物料類別'] ? material['預設物料類別'] : '';
                        materialBuffer[materialBuffer_ptr].幣別 = material['幣別'] ? material['幣別'] : 'TWD';
                        materialBuffer[materialBuffer_ptr].ext.unitPrice_substituted = unitPrice;
                        materialBuffer[materialBuffer_ptr].ext.isInDataFrame = true;
                        setUnitPriceInputBinding(true);
                        handleUnitPriceChange();
                    }
                    else {
                        setDFlexElmVisibility(addMaterialBtn, true);
                        setDFlexElmVisibility(updateMaterialBtn, false);
                        setDFlexElmVisibility(showPurchaseHistoryBtn, false);
                        document.getElementById('parts-name').textContent = '';
                        document.getElementById('unit-price').textContent = '';
                        document.getElementById('Input_materialType').value = '';
                        document.getElementById('Input_materialType').disabled  = true;
                        document.documentElement.style.setProperty('--bracket-before', '""');
                        document.documentElement.style.setProperty('--bracket-after', '""');
                        materialBuffer[materialBuffer_ptr].物料類別 = '';
                        materialBuffer[materialBuffer_ptr].幣別 = '';
                        materialBuffer[materialBuffer_ptr].ext.unitPrice_substituted = 0;
                        materialBuffer[materialBuffer_ptr].ext.isInDataFrame = false;
                        setUnitPriceInputBinding(true);
                        handleUnitPriceChange();
                    }
                }
                else if (isMaterialChange) {
                    setDFlexElmVisibility(addMaterialBtn, true);
                    setDFlexElmVisibility(updateMaterialBtn, false);
                    setDFlexElmVisibility(showPurchaseHistoryBtn, false);
                    document.getElementById('parts-name').textContent = '';
                    document.getElementById('unit-price').textContent = '';
                    document.getElementById('Input_materialType').value = '';
                    document.getElementById('Input_materialType').disabled  = true;
                    document.documentElement.style.setProperty('--bracket-before', '""');
                    document.documentElement.style.setProperty('--bracket-after', '""');
                    materialBuffer[materialBuffer_ptr].物料類別 = '';
                    materialBuffer[materialBuffer_ptr].幣別 = '';
                    materialBuffer[materialBuffer_ptr].ext.unitPrice_substituted = 0;
                    materialBuffer[materialBuffer_ptr].ext.isInDataFrame = false;
                    setUnitPriceInputBinding(true);
                    handleUnitPriceChange();
                }
            }

            // 數量區塊輸入值變化狀態處理器
            function handleInputQntyChange() {
                const quantity = document.getElementById('Input_quantity').value;
                materialBuffer[materialBuffer_ptr].需求數量 = quantity ? quantity : 0;
                handleTotalPriceChange();
            }

            // 單價區塊輸入值變化狀態處理器
            function handleInputUnitPriceChange() {
                const unitPrice = document.getElementById('Input_unitPrice').value;
                materialBuffer[materialBuffer_ptr].ext.unitPrice_input = unitPrice ? unitPrice : 0;
                handleUnitPriceChange();
            }

            // 單價區塊取值判斷器
            function handleUnitPriceChange() {
                if (materialBuffer[materialBuffer_ptr].ext.isUnitPriceInputBinding)
                    materialBuffer[materialBuffer_ptr].單價 = materialBuffer[materialBuffer_ptr].ext.unitPrice_substituted;
                else
                    materialBuffer[materialBuffer_ptr].單價 = materialBuffer[materialBuffer_ptr].ext.unitPrice_input;
                handleTotalPriceChange();
            }

            // 價格計算區塊輸入值變化狀態處理器。基於 "請購數量" or "物料選擇" 變化，計算並顯示新的單品總價格。
            function handleTotalPriceChange() {
                let unitPrice = materialBuffer[materialBuffer_ptr].單價;
                let quantity = materialBuffer[materialBuffer_ptr].需求數量;
                let totalPrice = parseFloat((unitPrice * quantity).toFixed(3));

                document.getElementById('unit-price-2').textContent = `${unitPrice}`;
                document.getElementById('total-price').textContent = quantity ? `${totalPrice}` : '';
            }

            // 以附檔名,apping到對應的icon設定
            function getIconConf(extension) {
                const fileDetails = {
                    pdf: { icon: 'bi-file-earmark-pdf-fill', type: 'PDF', color: '#D32F2F' },               // Red
                    doc: { icon: 'bi-file-earmark-word-fill', type: 'Word', color: '#1976D2' },             // Blue
                    docx: { icon: 'bi-file-earmark-word-fill', type: 'Word', color: '#1976D2' },            // Blue
                    xls: { icon: 'bi-file-earmark-spreadsheet-fill', type: 'Excel', color: '#388E3C' },     // Green
                    xlsx: { icon: 'bi-file-earmark-spreadsheet-fill', type: 'Excel', color: '#388E3C' },    // Green
                    ppt: { icon: 'bi-file-earmark-ppt-fill', type: 'PowerPoint', color: '#F57C00' },        // Orange
                    pptx: { icon: 'bi-file-earmark-ppt-fill', type: 'PowerPoint', color: '#F57C00' },       // Orange
                    jpg: { icon: 'bi-file-earmark-image-fill', type: 'Image', color: '#8E24AA' },           // Purple
                    jpeg: { icon: 'bi-file-earmark-image-fill', type: 'Image', color: '#8E24AA' },          // Purple
                    png: { icon: 'bi-file-earmark-image-fill', type: 'Image', color: '#8E24AA' },           // Purple
                    gif: { icon: 'bi-file-earmark-image-fill', type: 'Image', color: '#8E24AA' },           // Purple
                    bmp: { icon: 'bi-file-earmark-image-fill', type: 'Image', color: '#8E24AA' },           // Purple
                    mp4: { icon: 'bi-file-earmark-play-fill', type: 'Video', color: '#009688' },            // Teal
                    avi: { icon: 'bi-file-earmark-play-fill', type: 'Video', color: '#009688' },            // Teal
                    mov: { icon: 'bi-file-earmark-play-fill', type: 'Video', color: '#009688' },            // Teal
                    mp3: { icon: 'bi-file-earmark-music-fill', type: 'Audio', color: '#E91E63' },           // Magenta
                    wav: { icon: 'bi-file-earmark-music-fill', type: 'Audio', color: '#E91E63' },           // Magenta
                    zip: { icon: 'bi-file-earmark-zip-fill', type: 'Archive', color: '#795548' },           // Brown
                    rar: { icon: 'bi-file-earmark-zip-fill', type: 'Archive', color: '#795548' },           // Brown
                    csv: { icon: 'bi-file-earmark-spreadsheet-fill', type: 'CSV', color: '#388E3C' },       // Green
                    txt: { icon: 'bi-file-earmark-text-fill', type: 'Text', color: '#616161' }              // Grey
                };
                const defaultReturn = { icon: 'bi-file-earmark-fill', type: 'File', color: '#616161' };     // Grey for default
                return fileDetails[extension] || defaultReturn;
            }

            // 預覽檔案
            function previewFile(buffer) {
                const iframe = document.getElementById('filePreviewIframe');
                const videoPlayer = document.getElementById('videoPlayer');
                const audioPlayer = document.getElementById('audioPlayer');

                // 隱藏所有播放器
                iframe.classList.add('d-none');
                videoPlayer.classList.add('d-none');
                audioPlayer.classList.add('d-none');

                if (buffer.ext.預覽檔案狀態 === 'success') {
                    const fileUrl = URL.createObjectURL(buffer.ext.預覽檔案);
                    
                    switch(buffer.ext.檔案種類.toLowerCase()) {
                        case 'pdf':
                        case 'image':
                        case 'word':
                        case 'powerpoint':
                        case 'excel':
                        case 'text':
                            iframe.src = fileUrl;
                            iframe.classList.remove('d-none');
                            break;
                        case 'video':
                            videoPlayer.src = fileUrl;
                            videoPlayer.load();
                            videoPlayer.classList.remove('d-none');
                            break;
                        case 'audio':
                            audioPlayer.src = fileUrl;
                            audioPlayer.load();
                            audioPlayer.classList.remove('d-none');
                            break;
                        default:
                            return;
                    }

                    new bootstrap.Modal(document.getElementById('filePreviewModal')).show();
                    document.getElementById('filePreviewModal').addEventListener('hidden.bs.modal', () => {
                        URL.revokeObjectURL(fileUrl);
                        iframe.src = '';
                        videoPlayer.src = '';
                        audioPlayer.src = '';
                        iframe.classList.add('d-none');
                        videoPlayer.classList.add('d-none');
                        audioPlayer.classList.add('d-none');
                    }, { once: true });
                }
                else if (buffer.ext.預覽檔案狀態 === 'loading')
                    alert('預覽圖載入中，請稍後再試');
                else if (buffer.ext.預覽檔案狀態 === 'unsupported')
                    alert('此檔案格式不支援預覽');
                else if (buffer.ext.預覽檔案狀態 === 'init')
                    alert('檔案處理中，請稍後再試');
                else if (buffer.ext.預覽檔案狀態 === 'failed')
                    alert('預覽圖轉檔失敗');
            }

            // 計算檔案SHA-256值
            async function calculateHash(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        crypto.subtle.digest('SHA-256', reader.result).then(hashBuffer => {
                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                            resolve(hashHex);
                        }).catch(reject);
                    };
                    reader.onerror = () => reject(reader.error);
                    reader.readAsArrayBuffer(file);
                });
            }

            // 匯入檔案處理
            async function handleFiles(files) {
                // 輸入參數檢查
                if (!files) return;

                const fileList = document.getElementById('fileList');   
                const promises = Array.from(files).map(async (file, i) => {
                    const current_ptr = fileBuffer_ptr;
                    const parts = files[i].name.split('.');
                    const extension = parts.pop().toLowerCase(); // 獲取副檔名並轉為小寫
                    const nameWithoutExtension = parts.join('.'); // 將剩下的部分重新組合成檔名
                    const iconConf = getIconConf(extension);

                    fileBuffer[fileBuffer_ptr++] = createFileBuffer();
                    const buffer = fileBuffer[current_ptr];
                    buffer.ext.檔案 = files[i];
                    buffer.ext.檔案種類 = iconConf.type;
                    buffer.ext.圖示bs = iconConf.icon;
                    buffer.ext.圖示顏色 = iconConf.color;
                    buffer.ext.預覽檔案 = null;
                    buffer.ext.預覽檔案狀態 = 'init';
                    buffer.內容分類 = '其他文件';
                    buffer.檔案說明 = nameWithoutExtension;
                    buffer.副檔名 = extension;

                    // 使用模板字串創建代表檔案的區塊
                    const block = `
                        <div id="fileCtrlBlock-${current_ptr}" class="fileCtrlBlock position-relative border rounded p-3 mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <button type="button" class="fileBox btn btn-light flex-shrink-0 me-3">
                                    <i class="bi ${buffer.ext.圖示bs} fs-1" style="color: ${buffer.ext.圖示顏色};"></i>
                                </button>
                                <div class="flex-grow-1 file-info-grid">
                                    <div class="editedFileName">檔案說明:</div>
                                    <div id="file-stmt-${current_ptr}">
                                        <input id=file-stmt-input-${current_ptr} type="text" value="${buffer.檔案說明}" class="fileStmt-input border-0 pe-3 w-100" list="file-stmt-input-datalist-${current_ptr}"/>
                                        <datalist id="file-stmt-input-datalist-${current_ptr}">
                                            <option value="${buffer.檔案說明}">${buffer.檔案說明}</option>
                                        </datalist>
                                    </div>
                                    <div>內容分類:</div>
                                    <div id="file-type-${current_ptr}">
                                        <select id="file-type-selector-${current_ptr}" class="fileContentType-select form-select form-select-sm" value="">
                                            <option value="" hidden>請選擇檔案分類 （預設選項 = "其他文件"）</option>
                                            <option value="報價單">報價單</option>
                                            <option value="規格圖">規格圖</option>
                                            <option value="計畫書">計畫書</option>
                                            <option value="其他文件">其他文件</option>
                                        </select>
                                    </div>
                                    <div>狀態/路徑:</div>
                                    <div id="file-status-${current_ptr}" class="text-truncate">
                                        <i class="bi bi-upload icon text-info"></i>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="remove-btn btn btn-danger btn-sm rounded-circle d-flex align-items-center justify-content-center">&times;</button>
                        </div>
                    `;
                    const blockElement = document.createRange().createContextualFragment(block);
                    fileList.appendChild(blockElement);

                    // 绑定事件處理程序
                    fileList.querySelector('#fileCtrlBlock-' + current_ptr.toString() + ' .fileBox').addEventListener('click', () => previewFile(buffer), false);
                    fileList.querySelector('#fileCtrlBlock-' + current_ptr.toString() + ' .remove-btn').addEventListener('click', () => deleteFileBuffer(current_ptr), false);
                    fileList.querySelector('#fileCtrlBlock-' + current_ptr.toString() + ' .fileStmt-input').addEventListener('input', event => buffer.檔案說明 = event.target.value, false);
                    fileList.querySelector('#fileCtrlBlock-' + current_ptr.toString() + ' .fileContentType-select').addEventListener('change', event => buffer.內容分類 = event.target.value, false);
                    
                    // 計算檔案哈希值
                    buffer.哈希值 = await calculateHash(buffer.ext.檔案);

                    // 發送hash至後端檢查檔案是否存在
                    let checkFileExistenceReturn = await checkFileExistence({hash: buffer.哈希值});

                    const fileStmtDatalist = document.getElementById(`file-stmt-${current_ptr}`).querySelector('datalist');
                    const fileTypeSelector = document.getElementById(`file-type-${current_ptr}`).querySelector('select');
                    const fileStatus = document.getElementById(`file-status-${current_ptr}`);

                    if (checkFileExistenceReturn && checkFileExistenceReturn.found) {
                        if (checkFileExistenceReturn.檔案說明 && checkFileExistenceReturn.檔案說明 !== buffer.檔案說明) {
                            alert('上傳的檔案存在於檔案管理系統，但檔案說明(檔名)不相同！\n提交表單後，將優先使用新的檔案說明！');
                            fileStmtDatalist.appendChild(new Option(checkFileExistenceReturn.檔案說明, checkFileExistenceReturn.檔案說明));
                        }
                        if (checkFileExistenceReturn.副檔名 && checkFileExistenceReturn.副檔名 !== buffer.副檔名) {
                            alert('檔案副檔名衝突！\n提交表單後，將優先使用新的副檔名');
                        }
                        buffer.默認主鍵 = checkFileExistenceReturn.默認主鍵;
                        buffer.內容分類 = checkFileExistenceReturn.內容分類 || '';
                        buffer.檔案說明 = buffer.檔案說明 || checkFileExistenceReturn.檔案說明 || '';
                        buffer.副檔名 = buffer.副檔名 || checkFileExistenceReturn.副檔名 || '';
                        buffer.檔案路徑 = checkFileExistenceReturn.檔案路徑;
                        fileTypeSelector.value = checkFileExistenceReturn.內容分類 || '';
                        fileStatus.innerHTML = `<i class="bi bi-check-circle-fill text-success me-1"></i> ${checkFileExistenceReturn.檔案路徑}`;
                    }
                    else {
                        // 伺服器暫存
                        fileStatus.innerHTML = `<i class="bi bi-upload text-info me-2"></i>正在上傳檔案...`;
                        const formData = new FormData();
                        formData.append('file', buffer.ext.檔案);
                        formData.append('內容分類', buffer.內容分類);
                        formData.append('檔案說明', buffer.檔案說明);
                        formData.append('副檔名', buffer.副檔名);
                        formData.append('哈希值', buffer.哈希值);

                        let cacheFileReturn = await cacheAttachment(formData);
                        
                        buffer.默認主鍵 = cacheFileReturn.id;
                        buffer.檔案路徑 = cacheFileReturn.path;
                        fileStatus.innerHTML = `<i class="bi bi-check-circle-fill text-success me-1"></i> ${cacheFileReturn.path}`;
                    }

                    // 預覽檔案處理
                    switch(buffer.ext.檔案種類.toLowerCase()) {
                        case 'PDF'.toLowerCase():
                        case 'Image'.toLowerCase():
                        case 'Video'.toLowerCase():
                        case 'Audio'.toLowerCase():
                        case 'Text'.toLowerCase():
                            buffer.ext.預覽檔案 = buffer.ext.檔案;
                            buffer.ext.預覽檔案狀態 = 'success';
                            break;
                        case 'Word'.toLowerCase():
                        case 'PowerPoint'.toLowerCase():
                        case 'Excel'.toLowerCase():
                            buffer.ext.預覽檔案 = null;
                            buffer.ext.預覽檔案狀態 = 'loading';
                            if (buffer.默認主鍵) {
                                let = fetchPreviewFileReturn = await fetchPreviewFile(buffer.默認主鍵)
                                if (fetchPreviewFileReturn.file) {
                                    buffer.ext.預覽檔案 = fetchPreviewFileReturn.file;
                                    buffer.ext.預覽檔案狀態 = 'success';
                                }
                                else {
                                    buffer.ext.預覽檔案 = null;
                                    buffer.ext.預覽檔案狀態 = 'failed';
                                }
                            }
                            else {
                                const formData = new FormData();
                                formData.append('file', buffer.ext.檔案);
                                formData.append('extension', buffer.副檔名);

                                let convertToPreviewFileReturn = await convertToPreviewFile(formData);
                                if (convertToPreviewFileReturn.file) {
                                    buffer.ext.預覽檔案 = convertToPreviewFileReturn.file;
                                    buffer.ext.預覽檔案狀態 = 'success';
                                }
                                else {
                                    buffer.ext.預覽檔案 = null;
                                    buffer.ext.預覽檔案狀態 = 'failed';
                                }
                            }
                            break;
                        default:
                            buffer.ext.預覽檔案 = null;
                            buffer.ext.預覽檔案狀態 = 'unsupported';
                            break;
                    }
                });
                await Promise.all(promises);
            }

            // 延遲觸發函數，降低效能影響
            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // 封裝需要被延遲執行的函數
            const debounceHandleMtrlSecStatus = debounce(handleMtrlSecStatus, 250);
            const debounceHandleInputQntyChange = debounce(handleInputQntyChange, 250);
            const debouncehandleInputUnitPriceChange = debounce(handleInputUnitPriceChange, 250);

            function startUp() {
                // 動態載入資料集
                Promise.all(resourceName_get.map(fetchResource)).then(() => {
                    setupSelectOptions(document.getElementById('material_datalist'), dataFrame.materials['物料代號'].values);           // 物料表>料號
                    setupSelectOptions(document.getElementById('supplier_datalist'), dataFrame.materials['供應商簡稱'].values);         // 物料表>供應商
                    setupSelectOptions(document.getElementById('Input_materialType'), dataFrame.materialType['類別'].values);           // 物料類別
                    setupSelectOptions(document.getElementById('employee_datalist'), dataFrame.employees['工號簡碼'].values);           // 申請人
                    setupSelectOptions(document.getElementById('Input_delieveryOffice'), dataFrame.minmaxOffice['廠區名稱'].values);    // 收貨廠區
                    setupSelectOptions(document.getElementById('Input_purchaseReason'), dataFrame.purchaseType['類型'].values);         // 請購原因
                    setupSelectOptions(document.getElementById('Input_projectName'), dataFrame.projects['專案名稱'].values, true);      // 隸屬於專案
                })
                .catch(error => console.error('Error during startup:', error));

                // 設置表單智慧輸入建議的事件觸發與處理器
                document.getElementById('Input_materialId').addEventListener('input', debounceHandleMtrlSecStatus, false);
                document.getElementById('Input_supplier').addEventListener('input', debounceHandleMtrlSecStatus, false);
                document.getElementById('Input_materialType').addEventListener('input', debounceHandleMtrlSecStatus, false);
                document.getElementById('Input_quantity').addEventListener('input', debounceHandleInputQntyChange, false);
                document.getElementById('Input_unitPrice').addEventListener('input', debouncehandleInputUnitPriceChange, false);
                
                // 輸入框內容快捷清除功能的事件觸發與處理器
                document.getElementById('Input_materialId').addEventListener('input', setEraseIconVisibility, false);
                document.getElementById('Input_supplier').addEventListener('input', setEraseIconVisibility, false);
                document.getElementById('Input_applier').addEventListener('input', setEraseIconVisibility, false);

                // 物料快捷功能: {創建新物料 / 申報物料遺漏 / 更新物料資訊 / 顯示物料請購歷史} 的事件觸發與處理器
                document.getElementById('add-material-btn').addEventListener('input', () => redirectToMaterialForm('創建'), false);
                document.getElementById('update-material-btn').addEventListener('input', () => redirectToMaterialForm('更新'), false);
                document.getElementById('show-purchase-history-btn').addEventListener('input', () => '待開發', false);

                // 設置物料區塊欄位清除內容按鈕的事件觸發與處理器
                Array.from(document.getElementsByClassName('clr-input-btn')).forEach(button => button.addEventListener('click', clearTextbox, false));

                // 禁止全頁面層級drag事件瀏覽器預設行為
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => document.body.addEventListener(eventName, event => (event.preventDefault(), event.stopPropagation()), false));

                // 上傳檔案的事件觸發與處理器
                document.getElementById('Input_files').addEventListener('change', event => handleFiles(event.target.files), false);
                document.body.addEventListener('drop', event => handleFiles(event.dataTransfer.files), false);

                // 提交表單的事件觸發與處理器
                document.getElementById('purchase-request-form').addEventListener('submit', submitPurchaseReqStmtForm, false);
            }
            window.addEventListener('DOMContentLoaded', startUp, false);
        })();
    </script>
</body>

</html>